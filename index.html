<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale-1.0">
    <title>Gestor de Préstamos Diarios - PRESTA FÁCIL</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and ReactDOM -->
    <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
    <!-- Babel for JSX transpilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Firebase (v8 Compat Libraries for simplicity in single-file setup) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <style>
        /* Custom animation used in the component */
        @keyframes pulse-slow {
            50% {
                opacity: .7;
            }
        }
        .animate-pulse-slow {
            animation: pulse-slow 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        // Note: All 'import' statements are removed as libraries are loaded from CDN.
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- UTILIDADES Y LÓGICA DE NEGOCIO ---

        // Constante para el formato de moneda
        const CURRENCY_SYMBOL = 'S/.';

        // Función para inicializar Firebase (incluye autenticación)
        const setupFirebase = async (onUserStatusChange, setIsLoading) => {
            try {
                // Your web app's Firebase configuration
                const firebaseConfig = {
                    apiKey: "AIzaSyAjpaKhP0g_3XOmhijlD03rCezQoaCEZl8",
                    authDomain: "mis-prestamos-app-aa00c.firebaseapp.com",
                    projectId: "mis-prestamos-app-aa00c",
                    storageBucket: "mis-prestamos-app-aa00c.appspot.com",
                    messagingSenderId: "1032504750741",
                    appId: "1:1032504750741:web:418740d7b1bb75034fe19c"
                };

                if (!firebase.apps.length) {
                    firebase.initializeApp(firebaseConfig);
                }
                
                // Listener para cambios en el estado de autenticación
                firebase.auth().onAuthStateChanged(onUserStatusChange);

            } catch (error) {
                console.error("Error al configurar Firebase:", error);
                setIsLoading(false);
            }
        };

        // **IMPORTANTE**: La ruta ahora es pública y compartida para todos los usuarios.
        const getClientCollectionPath = () => `clients`;
        
        const getDueDate = (loan) => {
            const startDate = new Date(loan.startDate);
            const restDay = loan.restDay !== undefined && loan.restDay !== null ? loan.restDay : -1; 
            
            if (loan.loanType === 'monthly' && loan.termMonths > 0) {
                const dueDate = new Date(startDate);
                dueDate.setMonth(dueDate.getMonth() + loan.termMonths);
                return dueDate;
            }

            if (loan.loanType === 'daily' && loan.termDays > 0) {
                const startDateNormalized = new Date(startDate);
                startDateNormalized.setHours(0, 0, 0, 0); 
                
                let currentDate = new Date(startDateNormalized);
                let daysToCollect = loan.termDays; 
                let installmentsCounted = 0;
                
                while (installmentsCounted < daysToCollect) {
                    if (installmentsCounted > 0) {
                         currentDate.setDate(currentDate.getDate() + 1);
                    }
                    const dayOfWeek = currentDate.getDay();
                    if (dayOfWeek !== restDay) {
                        installmentsCounted++;
                    }
                }
                return currentDate;
            }
            return null;
        }

        const countEffectiveInterestDays = (startDateString, restDay, loanType) => {
            const startDate = new Date(startDateString);
            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            startDate.setHours(0, 0, 0, 0); 
            
            if (loanType === 'monthly') {
                return 0; 
            }
            
            let interestDays = 0;
            let currentDate = new Date(startDate);
            
            const effectiveRestDay = restDay !== null ? restDay : 0; 

            while (currentDate <= today) {
                const dayOfWeek = currentDate.getDay();
                if (dayOfWeek !== effectiveRestDay) {
                    interestDays++;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return interestDays;
        };

        const calculateLoanBalance = (loan) => {
            const restDay = loan.restDay !== undefined ? loan.restDay : 0; 
            
            const principalPaid = loan.paymentHistory
                .filter(p => p.isInterest === false) 
                .reduce((sum, p) => sum + p.amount, 0);

            const principalRemaining = Math.max(0, loan.principal - principalPaid);

            const interestPaid = loan.paymentHistory
                .filter(p => p.isInterest === true) 
                .reduce((sum, p) => sum + p.amount, 0);

            let totalInterestAccrued = 0;
            let fixedDailyInstallment = null;
            let totalInstallments = null;
            let paymentsMade = loan.paymentHistory.length;
            let totalRemainingFinal = 0;
            let principalRemainingFinal = principalRemaining;
            let interestRemainingFinal = 0;

            if (loan.loanType === 'daily') {
                if (loan.accrualModel === 'fixed_installment') {
                    totalInterestAccrued = loan.principal * loan.interestRate;
                    totalInstallments = loan.termDays;
                    if (loan.termDays > 0) {
                        fixedDailyInstallment = (loan.principal + totalInterestAccrued) / loan.termDays;
                        fixedDailyInstallment = parseFloat(fixedDailyInstallment.toFixed(2));
                    } else {
                        fixedDailyInstallment = 0;
                    }
                    interestRemainingFinal = Math.max(0, totalInterestAccrued - interestPaid);
                    principalRemainingFinal = principalRemaining;
                    totalRemainingFinal = principalRemainingFinal + interestRemainingFinal;
                } else if (loan.accrualModel === 'fixed_term') {
                    totalInterestAccrued = loan.principal * loan.interestRate;
                    interestRemainingFinal = Math.max(0, totalInterestAccrued - interestPaid);
                    totalRemainingFinal = principalRemainingFinal + interestRemainingFinal;
                } else {
                    const interestDays = countEffectiveInterestDays(loan.startDate, restDay, loan.loanType);
                    totalInterestAccrued = (loan.principal * loan.interestRate) * interestDays;
                    interestRemainingFinal = Math.max(0, totalInterestAccrued - interestPaid);
                    totalRemainingFinal = principalRemainingFinal + interestRemainingFinal;
                }
            } else if (loan.loanType === 'monthly') {
                totalInterestAccrued = loan.principal * loan.interestRate * loan.termMonths;
                interestRemainingFinal = Math.max(0, totalInterestAccrued - interestPaid);
                totalRemainingFinal = principalRemainingFinal + interestRemainingFinal;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); 
            
            const dueDateObj = getDueDate(loan);
            let isOverdue = false;
            let dueDateString = null;

            if (dueDateObj) {
                dueDateObj.setHours(0, 0, 0, 0); 
                dueDateString = dueDateObj.toISOString().substring(0, 10);
                if (loan.status === 'Active' && totalRemainingFinal > 0.01 && today > dueDateObj) {
                    isOverdue = true;
                }
            }

            return { 
                principalRemaining: parseFloat(principalRemainingFinal.toFixed(2)), 
                interestRemaining: parseFloat(interestRemainingFinal.toFixed(2)), 
                totalRemaining: parseFloat(totalRemainingFinal.toFixed(2)),
                totalInterestAccrued: parseFloat(totalInterestAccrued.toFixed(2)),
                fixedDailyInstallment: fixedDailyInstallment,
                paymentsMade: paymentsMade,
                totalInstallments: totalInstallments,
                isOverdue: isOverdue, 
                dueDate: dueDateString 
            };
        };

        const exportToCSV = (payments, clientName, loanPrincipal) => {
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Fecha,Monto,Tipo de Pago (Int./Cap.),Cliente,Préstamo Principal\n";
            payments.sort((a, b) => new Date(a.date) - new Date(b.date)).forEach(payment => {
                const type = payment.isInterest ? "Interés" : "Capital";
                const row = [
                    payment.date,
                    `${CURRENCY_SYMBOL}${payment.amount.toFixed(2)}`,
                    type,
                    clientName,
                    `${CURRENCY_SYMBOL}${loanPrincipal.toFixed(2)}`
                ].join(",");
                csvContent += row + "\n";
            });
            return encodeURI(csvContent);
        };

        const calculateMonthlyPerformance = (clients) => {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth();
            let monthlyInterestGain = 0;
            let monthlyPrincipalGain = 0;
            clients.forEach(client => {
                client.loans.forEach(loan => {
                    loan.paymentHistory.forEach(payment => {
                        // FIX: Replace hyphens with slashes to ensure date is parsed in local timezone
                        const paymentDate = new Date(payment.date.replace(/-/g, '/'));
                        if (paymentDate.getFullYear() === currentYear && paymentDate.getMonth() === currentMonth) {
                            if (payment.isInterest) {
                                monthlyInterestGain += payment.amount;
                            } else {
                                monthlyPrincipalGain += payment.amount;
                            }
                        }
                    });
                });
            });
            return {
                interestGain: parseFloat(monthlyInterestGain.toFixed(2)),
                principalGain: parseFloat(monthlyPrincipalGain.toFixed(2)),
            };
        };

        const calculateHistoricalPerformance = (clients, year) => {
            const monthlyTotals = Array(12).fill(0);
            clients.forEach(client => {
                client.loans.forEach(loan => {
                    loan.paymentHistory.forEach(payment => {
                        if (payment.isInterest) {
                            const paymentDate = new Date(payment.date.replace(/-/g, '/'));
                            if (!isNaN(paymentDate.getTime()) && paymentDate.getFullYear() === year) {
                                const month = paymentDate.getMonth();
                                monthlyTotals[month] += payment.amount;
                            }
                        }
                    });
                });
            });
            return monthlyTotals.map(total => parseFloat(total.toFixed(2)));
        };

        const Header = ({ title, onLogout }) => (
            <header className="py-4 px-6 bg-blue-900 text-white shadow-lg sticky top-0 z-10 flex justify-between items-center">
                <div>
                    <h1 className="text-2xl font-bold tracking-tight">{title}</h1>
                    <p className="text-sm opacity-90 mt-1">Gestión de Préstamos</p>
                </div>
                <button 
                    onClick={onLogout}
                    className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-200"
                >
                    Cerrar Sesión
                </button>
            </header>
        );

        const IconButton = ({ children, onClick, className = '' }) => (
            <button
                onClick={onClick}
                className={`p-2 rounded-full bg-blue-700 hover:bg-blue-800 text-white transition duration-200 shadow-md ${className}`}
            >
                {children}
            </button>
        );

        const LoginView = ({ onLogin, error }) => {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(email, password);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-gray-200">
                    <div className="bg-white p-8 rounded-xl shadow-2xl w-full max-w-md">
                        <h1 className="text-3xl font-bold text-center text-blue-900 mb-2">PRESTA FÁCIL</h1>
                        <p className="text-center text-gray-600 mb-6">Inicio de Sesión</p>
                        {error && <p className="bg-red-100 text-red-700 p-3 rounded-lg text-center mb-4">{error}</p>}
                        <form onSubmit={handleSubmit} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Correo Electrónico</label>
                                <input
                                    type="email"
                                    value={email}
                                    onChange={(e) => setEmail(e.target.value)}
                                    required
                                    className="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-medium text-gray-700">Contraseña</label>
                                <input
                                    type="password"
                                    value={password}
                                    onChange={(e) => setPassword(e.target.value)}
                                    required
                                    className="mt-1 w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700"
                                />
                            </div>
                            <button
                                type="submit"
                                className="w-full bg-blue-800 text-white p-3 rounded-xl font-bold hover:bg-blue-900 transition duration-200 shadow-lg"
                            >
                                Ingresar
                            </button>
                        </form>
                    </div>
                </div>
            );
        };
        
        const MainApp = ({ user, userRole, onLogout }) => {
            const [clients, setClients] = useState([]);
            const [currentView, setCurrentView] = useState('dashboard');
            const [selectedClientId, setSelectedClientId] = useState(null);
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [modalContent, setModalContent] = useState({ title: '', body: null });
            const db = firebase.firestore();

            const selectedClient = useMemo(() => clients.find(c => c.id === selectedClientId), [clients, selectedClientId]);

            useEffect(() => {
                if (!db || !user) return;
                const unsubscribe = db.collection(getClientCollectionPath()).onSnapshot((snapshot) => {
                    const clientData = snapshot.docs.map(doc => ({
                        id: doc.id,
                        ...doc.data()
                    }));
                    setClients(clientData);
                    console.log("Datos de clientes (compartidos) actualizados.");
                }, (error) => {
                    console.error("Error al escuchar clientes:", error);
                });
                return () => unsubscribe();
            }, [db, user]);

            const generalSummary = useMemo(() => {
                let totalPrincipal = 0;
                let totalPrincipalRemaining = 0;
                let totalInterestPaid = 0;
                let totalLoansActive = 0;
                let totalAccruedInterest = 0;
                clients.forEach(client => {
                    client.loans.forEach(loan => {
                        const { principalRemaining, totalInterestAccrued, isOverdue } = calculateLoanBalance(loan);
                        totalInterestPaid += loan.paymentHistory
                            .filter(p => p.isInterest)
                            .reduce((sum, p) => sum + p.amount, 0);
                        if (loan.status === 'Active' && (principalRemaining > 0.01 || isOverdue)) {
                             totalLoansActive++;
                        }
                        if (loan.status === 'Active') {
                            totalPrincipal += loan.principal;
                            totalPrincipalRemaining += principalRemaining;
                            totalAccruedInterest += totalInterestAccrued;
                        }
                    });
                });
                const interestRemainingTotal = Math.max(0, totalAccruedInterest - totalInterestPaid);
                const totalOutstanding = totalPrincipalRemaining + interestRemainingTotal;
                return {
                    totalPrincipal,
                    totalPrincipalRemaining,
                    totalInterestPaid: parseFloat(totalInterestPaid.toFixed(2)),
                    totalLoansActive,
                    totalOutstanding: parseFloat(totalOutstanding.toFixed(2)), 
                };
            }, [clients]);

            const monthlyPerformance = useMemo(() => calculateMonthlyPerformance(clients), [clients]);

            const openModal = (title, body) => {
                setModalContent({ title, body });
                setIsModalOpen(true);
            };

            const closeModal = () => {
                setIsModalOpen(false);
                setModalContent({ title: '', body: null });
            };

            const handleSaveClient = async (clientData, loanData, existingClientId = null) => {
                if (userRole !== 'admin') {
                    console.error("Permiso denegado: Se requiere rol de administrador.");
                    return;
                }

                const defaultTermDays = loanData.loanType === 'monthly' ? loanData.termMonths * 30 : null;
                const newLoan = {
                    ...loanData,
                    termDays: loanData.termDays || defaultTermDays,
                    loanId: crypto.randomUUID(),
                    totalAmountPaid: 0,
                    status: 'Active',
                    paymentHistory: []
                };

                // If a client ID is provided, we are updating that specific client.
                if (existingClientId) {
                    try {
                        const clientDocRef = db.collection(getClientCollectionPath()).doc(existingClientId);
                        await clientDocRef.update({
                            loans: firebase.firestore.FieldValue.arrayUnion(newLoan)
                        });
                        console.log("Préstamo añadido al cliente existente por ID:", existingClientId);
                        closeModal();
                        return;
                    } catch (error) {
                        console.error("Error al añadir préstamo a cliente existente:", error);
                        return;
                    }
                }

                // Logic to create a new client (with name verification)
                const clientsColRef = db.collection(getClientCollectionPath());
                try {
                    const clientNameLower = clientData.name.toLowerCase();
                    const existingClientSnapshot = await clientsColRef.where("name_lower", "==", clientNameLower).get();
                    
                    if (!existingClientSnapshot.empty) {
                        const clientDocRef = existingClientSnapshot.docs[0].ref;
                        await clientDocRef.update({
                            loans: firebase.firestore.FieldValue.arrayUnion(newLoan)
                        });
                        console.log("Préstamo añadido al cliente existente encontrado por nombre:", clientData.name);
                    } else {
                        const newClientDoc = {
                            name: clientData.name,
                            name_lower: clientNameLower,
                            phone: clientData.phone,
                            registeredBy: user.uid,
                            loans: [newLoan]
                        };
                        await clientsColRef.add(newClientDoc);
                        console.log("Nuevo cliente y préstamo creados:", clientData.name);
                    }
                    closeModal();
                    setCurrentView('clientList');
                } catch (error) {
                    console.error("Error al guardar cliente/préstamo:", error);
                }
            };
            
            const handleSavePayment = async (clientId, loanId, paymentAmount, paymentType, paymentDate) => {
                if (userRole !== 'admin') {
                    console.error("Permiso denegado: Se requiere rol de administrador.");
                    return;
                }
                try {
                    const clientDocRef = db.collection(getClientCollectionPath()).doc(clientId);
                    const client = clients.find(c => c.id === clientId);
                    if (!client) return;

                    const isInterestMap = {
                        'interest': true,
                        'principal': false,
                        'proportional': true
                    };
                    const isInterest = isInterestMap[paymentType];
                    
                    const updatedLoans = client.loans.map(loan => {
                        if (loan.loanId === loanId) {
                            const newPayment = {
                                date: paymentDate, 
                                amount: parseFloat(paymentAmount),
                                isInterest: isInterest,
                                paymentId: crypto.randomUUID()
                            };
                            const updatedHistory = [...loan.paymentHistory, newPayment];
                            const tempLoan = { ...loan, paymentHistory: updatedHistory };
                            const { totalRemaining } = calculateLoanBalance(tempLoan);
                            const newStatus = totalRemaining <= 0.01 ? 'PaidOff' : 'Active';
                            return { ...loan, paymentHistory: updatedHistory, status: newStatus };
                        }
                        return loan;
                    });
                    await clientDocRef.update({ loans: updatedLoans });
                    console.log("Pago registrado y balance actualizado.");
                } catch (error) {
                    console.error("Error al registrar el pago:", error);
                }
            };

            const handleDeletePayment = async (clientId, loanId, paymentId) => {
                if (userRole !== 'admin') {
                    console.error("Permiso denegado: Se requiere rol de administrador.");
                    return;
                }
                try {
                    const clientDocRef = db.collection(getClientCollectionPath()).doc(clientId);
                    const client = clients.find(c => c.id === clientId);
                    if (!client) return;
                    
                    const updatedLoans = client.loans.map(loan => {
                        if (loan.loanId === loanId) {
                            const updatedHistory = loan.paymentHistory.filter(p => p.paymentId !== paymentId);
                            const tempLoan = { ...loan, paymentHistory: updatedHistory };
                            const { totalRemaining } = calculateLoanBalance(tempLoan);
                            const newStatus = totalRemaining <= 0.01 ? 'PaidOff' : 'Active';
                            return { ...loan, paymentHistory: updatedHistory, status: newStatus };
                        }
                        return loan;
                    });
                    await clientDocRef.update({ loans: updatedLoans });
                    console.log("Pago eliminado y balance actualizado.");
                    closeModal();
                } catch (error) {
                    console.error("Error al eliminar el pago:", error);
                }
            };

            const handleDeleteLoan = async (clientId, loanId) => {
                if (userRole !== 'admin') {
                    console.error("Permiso denegado: Se requiere rol de administrador.");
                    return;
                }
                try {
                    const clientDocRef = db.collection(getClientCollectionPath()).doc(clientId);
                    const client = clients.find(c => c.id === clientId);
                    if (!client) return;
                    const updatedLoans = client.loans.filter(loan => loan.loanId !== loanId);
                    await clientDocRef.update({ loans: updatedLoans });
                    console.log("Préstamo eliminado exitosamente.");
                    closeModal();
                } catch (error) {
                    console.error("Error al eliminar el préstamo:", error);
                }
            };

            const handleDeleteClient = async (clientId) => {
                if (userRole !== 'admin') {
                    console.error("Permiso denegado: Se requiere rol de administrador.");
                    return;
                }

                const clientToDelete = clients.find(c => c.id === clientId);
                if (!clientToDelete || (clientToDelete.loans && clientToDelete.loans.length > 0)) {
                    console.error("No se puede eliminar este cliente o el cliente no fue encontrado.");
                    closeModal();
                    return;
                }

                try {
                    await db.collection(getClientCollectionPath()).doc(clientId).delete();
                    console.log("Cliente eliminado exitosamente.");
                    closeModal();
                    setSelectedClientId(null);
                    setCurrentView('clientList');
                } catch (error) {
                    console.error("Error al eliminar el cliente:", error);
                }
            };

            const ClientForm = ({ onSave, initialClient = null }) => {
                const [clientName, setClientName] = useState(initialClient ? initialClient.name : '');
                const [clientPhone, setClientPhone] = useState(initialClient ? initialClient.phone : '');
                const [principal, setPrincipal] = useState('');
                const [interestRate, setInterestRate] = useState('');
                const [loanDate, setLoanDate] = useState(new Date().toISOString().substring(0, 10));
                const [loanType, setLoanType] = useState('daily');
                const [termMonths, setTermMonths] = useState('1');
                const [termDays, setTermDays] = useState(''); 
                const [accrualModel, setAccrualModel] = useState('daily'); 

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!clientName || !principal || !interestRate || !loanDate || (loanType === 'monthly' && !termMonths)) return;
                    if (loanType === 'daily' && accrualModel === 'fixed_installment' && (!termDays || parseInt(termDays) <= 0)) {
                         console.error("Debe definir el plazo en días para la cuota fija.");
                         return;
                    }

                    const clientData = { name: clientName, phone: clientPhone };
                    const dateObj = new Date(loanDate);
                    dateObj.setDate(dateObj.getDate() + 1); 
                    const startDate = dateObj.toISOString().substring(0, 10);
                    
                    const finalTermDays = (loanType === 'daily' && (accrualModel === 'fixed_installment' || accrualModel === 'fixed_term' || accrualModel === 'daily'))
                        ? (parseInt(termDays) || null)
                        : null;
                    
                    const finalRestDay = loanType === 'monthly' ? null : 0;
                    
                    const loanData = {
                        principal: parseFloat(principal),
                        interestRate: parseFloat(interestRate) / 100, 
                        loanDate: loanDate,
                        startDate: startDate,
                        restDay: finalRestDay,
                        loanType: loanType,
                        termMonths: loanType === 'monthly' ? parseInt(termMonths) : null,
                        accrualModel: loanType === 'daily' ? accrualModel : null,
                        termDays: finalTermDays, 
                    };

                    onSave(clientData, loanData, initialClient ? initialClient.id : null);
                };

                const ratePlaceholder = useMemo(() => {
                    if (loanType === 'monthly') return 'Mensual (Ej: 10)';
                    switch (accrualModel) {
                        case 'daily': return 'Diaria (Ej: 1)';
                        case 'fixed_term': return 'Total Fijo (Ej: 10)';
                        case 'fixed_installment': return 'Total Fijo (Ej: 10)';
                        default: return 'Tasa';
                    }
                }, [loanType, accrualModel]);

                return (
                    <form onSubmit={handleSubmit} className="space-y-4 p-4 bg-white rounded-lg shadow-inner">
                        <h3 className="text-xl font-semibold border-b pb-2 text-blue-800">Datos del Cliente</h3>
                        <input type="text" placeholder="Nombre Completo" value={clientName} onChange={(e) => setClientName(e.target.value)} required disabled={!!initialClient} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700 disabled:bg-gray-100" />
                        <input type="tel" placeholder="Teléfono (Opcional)" value={clientPhone} onChange={(e) => setClientPhone(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                        <h3 className="text-xl font-semibold border-b pb-2 text-blue-800 pt-4">Detalles del Préstamo</h3>
                        <input type="number" placeholder={`Monto Principal (${CURRENCY_SYMBOL})`} value={principal} onChange={(e) => setPrincipal(e.target.value)} required min="1" step="0.01" className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                        <div className="flex space-x-2">
                            <select value={loanType} onChange={(e) => { setLoanType(e.target.value); setTermMonths('1'); setAccrualModel(e.target.value === 'daily' ? 'daily' : 'fixed_term'); setTermDays(''); }} required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700">
                                <option value="daily">Préstamo Diario</option>
                                <option value="monthly">Préstamo Plazo Fijo (Mensual)</option>
                            </select>
                            {loanType === 'monthly' && (
                                <select value={termMonths} onChange={(e) => setTermMonths(e.target.value)} required className="w-2/5 p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700">
                                    <option value="1">1 Mes</option>
                                    <option value="2">2 Meses</option>
                                    <option value="3">3 Meses</option>
                                    <option value="4">4 Meses</option>
                                    <option value="5">5 Meses</option>
                                    <option value="6">6 Meses</option>
                                </select>
                            )}
                        </div>
                        {loanType === 'daily' && (
                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <label className="block text-sm font-medium text-gray-700 mb-1">Modelo de Cálculo de Interés:</label>
                                <select value={accrualModel} onChange={(e) => { setAccrualModel(e.target.value); setTermDays(''); }} required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700">
                                    <option value="daily">Tasa Diaria Acumulativa (Interés Varía)</option>
                                    <option value="fixed_term">Interés Fijo Único (Pago Total Varía)</option>
                                    <option value="fixed_installment">Cuota Diaria Fija (Requiere Plazo en Días)</option>
                                </select>
                                <p className="text-xs mt-1 text-gray-600 italic">
                                    {accrualModel === 'fixed_installment' ? "Se calculará una cuota diaria fija: (Principal + Interés Fijo Total) / Plazo en Días." : accrualModel === 'fixed_term' ? "La tasa es el % total de interés a pagar. El pago diario no es fijo." : "La tasa diaria se acumula por día de cobro."}
                                </p>
                                <p className="text-sm mt-2 font-bold text-gray-800">Día de no cobro: Domingo.</p>
                            </div>
                        )}
                        {(loanType === 'daily' && accrualModel === 'fixed_installment') && (<input type="number" placeholder="Plazo Total en Días (Ej: 30)" value={termDays} onChange={(e) => setTermDays(e.target.value)} required min="1" className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />)}
                        {(loanType === 'daily' && accrualModel !== 'fixed_installment') && (<input type="number" placeholder="Plazo Opcional de Días (Para Vencimiento Estricto)" value={termDays} onChange={(e) => setTermDays(e.target.value)} min="1" className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />)}
                        <div className="flex space-x-2">
                            <input type="number" placeholder={`Tasa de Interés (${ratePlaceholder}) (%)`} value={interestRate} onChange={(e) => setInterestRate(e.target.value)} required min="0.01" step="0.01" className={`w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700`} />
                        </div>
                        <input type="date" placeholder="Fecha de Préstamo (Desembolso)" value={loanDate} onChange={(e) => setLoanDate(e.target.value)} required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                        <button type="submit" className="w-full bg-green-600 text-white p-3 rounded-xl font-bold hover:bg-green-700 transition duration-200 shadow-lg">{initialClient ? 'Añadir Nuevo Préstamo' : 'Guardar Cliente y Préstamo'}</button>
                    </form>
                );
            };

            const PaymentForm = ({ loan, clientId, onSavePayment, closeModal }) => {
                const { principalRemaining, interestRemaining, totalRemaining, fixedDailyInstallment } = calculateLoanBalance(loan);
                const [amount, setAmount] = useState('');
                const defaultPaymentType = loan.accrualModel === 'fixed_installment' || loan.loanType === 'monthly' ? 'proportional' : 'interest';
                const [paymentType, setPaymentType] = useState(defaultPaymentType); 
                const [paymentDate, setPaymentDate] = useState(new Date().toISOString().substring(0, 10)); 

                const handleSubmit = (e) => {
                    e.preventDefault();
                    if (!amount || parseFloat(amount) <= 0) return;
                    onSavePayment(clientId, loan.loanId, amount, paymentType, paymentDate);
                    closeModal();
                };
                
                const canPayPrincipal = principalRemaining > 0.01;
                const canPayInterest = interestRemaining > 0.01;
                const canPayProportional = totalRemaining > 0.01;

                return (
                    <form onSubmit={handleSubmit} className="space-y-4">
                        <p className="text-lg font-medium text-gray-700">Préstamo: {CURRENCY_SYMBOL}{loan.principal.toFixed(2)} al {(loan.interestRate * 100).toFixed(2)}%</p>
                        {fixedDailyInstallment && (
                            <div className="bg-blue-100 p-3 rounded-lg border border-blue-300 text-center">
                                <p className="font-semibold text-sm text-blue-800">CUOTA DIARIA FIJA RECOMENDADA</p>
                                <p className="text-3xl font-extrabold text-blue-700">{CURRENCY_SYMBOL}{fixedDailyInstallment.toFixed(2)}</p>
                            </div>
                        )}
                        <div className="bg-gray-100 p-3 rounded-lg border border-gray-300">
                            <p className="font-semibold">Saldo Pendiente:</p>
                            <p className="text-sm">Capital: <span className="font-bold text-red-600">{CURRENCY_SYMBOL}{principalRemaining.toFixed(2)}</span></p>
                            <p className="text-sm">Intereses: <span className="font-bold text-red-600">{CURRENCY_SYMBOL}{interestRemaining.toFixed(2)}</span></p>
                            <p className="text-base font-bold mt-1">Total: <span className="text-red-700">{CURRENCY_SYMBOL}{totalRemaining.toFixed(2)}</span></p>
                        </div>
                        <label className="block text-sm font-medium text-gray-700">Fecha del Pago</label>
                        <input type="date" aria-label="Fecha del Pago" value={paymentDate} onChange={(e) => setPaymentDate(e.target.value)} required className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                        <select value={paymentType} onChange={(e) => setPaymentType(e.target.value)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700">
                            <option value="interest" disabled={!canPayInterest}>Pago a Intereses</option>
                            <option value="principal" disabled={!canPayPrincipal}>Pago a Capital (Principal)</option>
                            {canPayProportional && (<option value="proportional">{loan.accrualModel === 'fixed_installment' ? 'Pago de Cuota Fija (Proporcional)' : 'Pago Mixto (Proporcional)'}</option>)}
                        </select>
                        <p className="text-xs italic text-gray-500 bg-gray-50 p-2 rounded-lg">
                            {paymentType === 'interest' && 'El pago reduce el saldo de Intereses pendiente.'}
                            {paymentType === 'principal' && 'El pago reduce el saldo de Capital pendiente.'}
                            {paymentType === 'proportional' && 'El pago reduce el saldo total pendiente. En Cuota Fija, se registra como Interés/Mixto.'}
                        </p>
                        <input type="number" placeholder="Monto del Pago" value={amount} onChange={(e) => setAmount(e.target.value)} required min="0.01" step="0.01" max={totalRemaining.toFixed(2)} className="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700" />
                        <button type="submit" disabled={totalRemaining <= 0} className="w-full bg-blue-700 text-white p-3 rounded-xl font-bold hover:bg-blue-800 transition duration-200 shadow-lg disabled:bg-gray-400">Registrar Pago</button>
                    </form>
                );
            };

            const LoanDetails = ({ loan, client, userRole, onDeletePayment, onDeleteLoan }) => {
                const clientId = client.id;
                const { principalRemaining, interestRemaining, totalRemaining, totalInterestAccrued, fixedDailyInstallment, paymentsMade, totalInstallments, isOverdue, dueDate } = calculateLoanBalance(loan);
                const interestPaid = loan.paymentHistory.filter(p => p.isInterest === true).reduce((sum, p) => sum + p.amount, 0);
                const principalPaid = loan.paymentHistory.filter(p => p.isInterest === false).reduce((sum, p) => sum + p.amount, 0);

                const handleAddPayment = () => openModal(`Registrar Pago - Préstamo ${CURRENCY_SYMBOL}${loan.principal.toFixed(2)}`, <PaymentForm loan={loan} clientId={clientId} onSavePayment={handleSavePayment} closeModal={closeModal} />);
                
                const confirmDeletePayment = (payment) => openModal('Confirmar Eliminación', (
                    <div className="text-center p-4">
                        <p className="text-lg mb-4">¿Estás seguro de que deseas eliminar este pago?</p>
                        <p className="mb-1 font-semibold text-gray-700">Fecha: <span className="font-normal">{payment.date}</span></p>
                        <p className="mb-4 font-semibold text-gray-700">Monto: <span className="font-normal">{CURRENCY_SYMBOL}{payment.amount.toFixed(2)}</span></p>
                        <div className="flex justify-center space-x-4 mt-6">
                            <button onClick={closeModal} className="px-6 py-2 rounded-xl bg-gray-300 text-gray-800 font-bold hover:bg-gray-400 transition shadow-sm">Cancelar</button>
                            <button onClick={() => onDeletePayment(client.id, loan.loanId, payment.paymentId)} className="px-6 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition shadow-md">Eliminar</button>
                        </div>
                    </div>
                ));

                const confirmDeleteLoan = () => openModal('Confirmar Eliminación de Préstamo', (
                    <div className="text-center p-4">
                        <p className="text-lg mb-2">¿Estás seguro de que deseas eliminar este préstamo de <span className="font-bold">{CURRENCY_SYMBOL}{loan.principal.toFixed(2)}</span>?</p>
                        <p className="text-sm text-red-700 bg-red-50 p-2 rounded-lg mb-6">Esta acción es irreversible y borrará todo su historial de pagos.</p>
                        <div className="flex justify-center space-x-4 mt-6">
                            <button onClick={closeModal} className="px-6 py-2 rounded-xl bg-gray-300 text-gray-800 font-bold hover:bg-gray-400 transition shadow-sm">Cancelar</button>
                            <button onClick={() => onDeleteLoan(client.id, loan.loanId)} className="px-6 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition shadow-md">Eliminar Préstamo</button>
                        </div>
                    </div>
                ));

                const handleExport = () => {
                    if (loan.paymentHistory.length === 0) return;
                    const csvData = exportToCSV(loan.paymentHistory, client.name, loan.principal);
                    const link = document.createElement('a');
                    link.setAttribute('href', csvData);
                    link.setAttribute('download', `${client.name.replace(/\s/g, '_')}_Prestamo_${loan.principal.toFixed(0)}_Pagos.csv`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };

                const statusClass = loan.status === 'PaidOff' ? 'bg-green-100 text-green-700' : isOverdue ? 'bg-red-600 text-white font-extrabold animate-pulse' : 'bg-red-100 text-red-700';
                const statusLabel = loan.status === 'PaidOff' ? 'Pagado' : isOverdue ? 'VENCIDO' : 'Activo';

                const rateLabel = useMemo(() => {
                    if (loan.loanType === 'monthly') return 'Tasa Mensual';
                    switch (loan.accrualModel) {
                        case 'daily': return 'Tasa Diaria';
                        case 'fixed_term':
                        case 'fixed_installment': return 'Tasa Fija Total por Plazo';
                        default: return 'Tasa';
                    }
                }, [loan.loanType, loan.accrualModel]);

                const loanTypeLabel = useMemo(() => {
                    if (loan.loanType === 'monthly') return `Mensual (${loan.termMonths}m)`;
                    switch(loan.accrualModel) {
                        case 'fixed_installment': return 'Diario (Cuota Fija)';
                        case 'fixed_term': return 'Diario (Interés Fijo Total)';
                        default: return 'Diario (Interés Acumulativo)';
                    }
                }, [loan.loanType, loan.accrualModel]);

                return (
                    <div className="p-4 border-b border-gray-200 bg-white rounded-xl shadow-md mb-4">
                        <div className="flex justify-between items-center mb-2">
                            <h4 className="text-lg font-bold text-blue-700">Préstamo {CURRENCY_SYMBOL} {loan.principal.toFixed(2)}<span className={`ml-3 text-xs font-semibold px-2 py-0.5 rounded-full ${statusClass}`}>{statusLabel}</span></h4>
                            {userRole === 'admin' && (
                                <div className="flex items-center space-x-2">
                                     {loan.status === 'Active' && (<button onClick={handleAddPayment} className="text-sm bg-blue-700 text-white px-3 py-1 rounded-full hover:bg-blue-800 transition">+ Pago</button>)}
                                    <button onClick={confirmDeleteLoan} className="p-1.5 rounded-full text-red-500 hover:bg-red-100 transition" title="Eliminar préstamo"><svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                </div>
                            )}
                        </div>
                        <div className="grid grid-cols-2 gap-2 text-sm text-gray-600">
                            <p>Tipo: <span className="font-semibold text-gray-800 ml-1">{loanTypeLabel}</span></p>
                            <p>{rateLabel}: <span className="font-semibold text-gray-800">{(loan.interestRate * 100).toFixed(2)}%</span></p>
                            {loan.loanType === 'daily' && (<p>Día Descanso: <span className="font-semibold text-gray-800">Domingo</span></p>)}
                            {loan.loanType === 'monthly' && <p></p>} 
                            {loan.termDays > 0 && (<p>Plazo Total: <span className="font-semibold text-gray-800">{loan.termDays} días</span></p>)}
                            <p>F. Préstamo (Desembolso): <span className="font-semibold text-gray-800">{loan.loanDate}</span></p>
                            <p>F. Inicio (1er Cobro): <span className="font-semibold text-gray-800">{loan.startDate}</span></p>
                            {dueDate && (<p className="col-span-2">F. Vencimiento: <span className={`font-semibold ml-1 ${isOverdue ? 'text-red-700 font-extrabold' : 'text-gray-800'}`}>{dueDate}</span></p>)}
                            <p className="col-span-2">Interés (Total Fijo/Devengado): <span className="font-semibold text-gray-800">{CURRENCY_SYMBOL}{totalInterestAccrued.toFixed(2)}</span></p>
                            <p>Capital Pagado: <span className="font-semibold text-gray-800 text-green-600">{CURRENCY_SYMBOL}{principalPaid.toFixed(2)}</span></p>
                            <p>Interés Pagado: <span className="font-semibold text-gray-800 text-green-600">{CURRENCY_SYMBOL}{interestPaid.toFixed(2)}</span></p>
                        </div>
                        {fixedDailyInstallment && (
                            <div className="mt-3 p-3 bg-blue-100 rounded-lg font-bold text-blue-800 text-center shadow-inner">
                                <p className="text-sm">CUOTA DIARIA FIJA</p>
                                <p className="text-3xl">{CURRENCY_SYMBOL}{fixedDailyInstallment.toFixed(2)}</p>
                                <p className="text-sm mt-1 font-semibold text-gray-600">Pagos Realizados: {paymentsMade} de {totalInstallments}</p>
                            </div>
                        )}
                        <div className="mt-3 p-3 bg-gray-50 rounded-lg font-bold text-gray-800 border border-gray-200">
                            <p>Saldo Capital Pendiente: <span className="text-red-600">{CURRENCY_SYMBOL}{principalRemaining.toFixed(2)}</span></p>
                            <p>Saldo Interés Pendiente: <span className="text-red-600">{CURRENCY_SYMBOL}{interestRemaining.toFixed(2)}</span></p>
                            <p>Saldo Total Pendiente: <span className="text-red-700">{CURRENCY_SYMBOL}{totalRemaining.toFixed(2)}</span></p>
                        </div>
                        <div className="mt-4 flex justify-end">
                            {loan.paymentHistory.length > 0 && (<button onClick={handleExport} className="text-sm bg-gray-200 text-gray-700 px-3 py-1 rounded-xl font-medium hover:bg-gray-300 transition flex items-center shadow-sm"><svg className="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>Exportar Historial</button>)}
                        </div>
                        <details className="mt-4">
                            <summary className="text-sm font-semibold text-gray-500 cursor-pointer">Ver Historial de Pagos ({loan.paymentHistory.length})</summary>
                            <div className="mt-2 h-24 overflow-y-auto bg-gray-50 p-2 rounded-lg">
                                {loan.paymentHistory.sort((a, b) => new Date(b.date) - new Date(a.date)).map((payment, index) => (
                                    <p key={payment.paymentId || index} className="text-xs border-b last:border-b-0 py-1 flex justify-between items-center group">
                                        <span><span className="text-gray-800">{payment.date}</span><span className={payment.isInterest ? 'text-blue-600 ml-2' : 'text-green-600 ml-2'}>{CURRENCY_SYMBOL}{payment.amount.toFixed(2)} ({payment.isInterest ? 'Int.' : 'Cap.'})</span></span>
                                        {userRole === 'admin' && (
                                            <button onClick={() => confirmDeletePayment(payment)} className="p-1 rounded-full text-red-500 hover:bg-red-100 opacity-0 group-hover:opacity-100 transition-opacity" title="Eliminar pago"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg></button>
                                        )}
                                    </p>
                                ))}
                            </div>
                        </details>
                    </div>
                );
            };

            const ClientDetailView = ({ client, userRole, handleDeletePayment, handleDeleteLoan, handleDeleteClient }) => {
                const handleAddLoan = () => openModal(`Añadir Nuevo Préstamo a ${client.name}`, <ClientForm onSave={(clientData, loanData) => handleSaveClient(clientData, loanData, client.id)} initialClient={client} />);
                
                const confirmDeleteClient = () => {
                    if (client.loans && client.loans.length > 0) return; 
                    openModal('Confirmar Eliminación de Cliente', (
                        <div className="text-center p-4">
                            <p className="text-lg mb-2">¿Estás seguro de que deseas eliminar permanentemente a <span className="font-bold">{client.name}</span>?</p>
                            <p className="text-sm text-red-700 bg-red-50 p-2 rounded-lg mb-6">Esta acción es irreversible.</p>
                            <div className="flex justify-center space-x-4 mt-6">
                                <button onClick={closeModal} className="px-6 py-2 rounded-xl bg-gray-300 text-gray-800 font-bold hover:bg-gray-400 transition shadow-sm">Cancelar</button>
                                <button onClick={() => handleDeleteClient(client.id)} className="px-6 py-2 rounded-xl bg-red-600 text-white font-bold hover:bg-red-700 transition shadow-md">Sí, Eliminar Cliente</button>
                            </div>
                        </div>
                    ));
                };

                return (
                    <div className="p-4 md:p-6 bg-white rounded-xl shadow-2xl space-y-4">
                        <div className="flex justify-between items-center border-b pb-3 mb-4">
                            <h2 className="text-3xl font-extrabold text-gray-900">{client.name}</h2>
                            {userRole === 'admin' && (
                                <div className="flex items-center space-x-2">
                                    <button onClick={handleAddLoan} className="bg-blue-700 text-white px-4 py-2 rounded-xl font-semibold hover:bg-blue-800 transition shadow-md">+ Nuevo Préstamo</button>
                                    <button 
                                        onClick={confirmDeleteClient}
                                        disabled={client.loans && client.loans.length > 0}
                                        title={client.loans && client.loans.length > 0 ? "No se puede eliminar un cliente con préstamos." : "Eliminar cliente"}
                                        className="p-2 rounded-xl font-semibold transition shadow-md bg-red-600 text-white hover:bg-red-700 disabled:bg-gray-400 disabled:cursor-not-allowed"
                                    >
                                        <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                                    </button>
                                </div>
                            )}
                        </div>
                        <p className="text-gray-600">Teléfono: <span className="font-medium">{client.phone || 'N/A'}</span></p>
                        <h3 className="text-xl font-bold text-blue-800 mt-6">Historial de Préstamos ({client.loans.length})</h3>
                        {client.loans.length > 0 ? (client.loans.map(loan => <LoanDetails key={loan.loanId} loan={loan} client={client} userRole={userRole} onDeletePayment={handleDeletePayment} onDeleteLoan={handleDeleteLoan} />)) : (<p className="text-gray-500 italic">Este cliente no tiene préstamos registrados.</p>)}
                    </div>
                );
            };

            const ClientListItem = ({ client }) => {
                let totalOutstanding = 0;
                let totalActiveLoans = 0;
                let isAnyOverdue = false;
                client.loans.forEach(loan => {
                    const balance = calculateLoanBalance(loan);
                    if (balance.totalRemaining > 0.01) {
                        totalActiveLoans++;
                        totalOutstanding += balance.totalRemaining;
                        if (balance.isOverdue) isAnyOverdue = true;
                    }
                });
                return (
                    <div onClick={() => { setSelectedClientId(client.id); setCurrentView('clientDetail'); }} className={`p-4 bg-white rounded-xl shadow-lg hover:shadow-xl transition duration-300 cursor-pointer border-l-4 ${isAnyOverdue ? 'border-red-600 animate-pulse-slow' : 'border-blue-700'}`}>
                        <div className="flex justify-between items-start">
                            <div className="flex flex-col"><h3 className="text-lg font-bold text-gray-800">{client.name}</h3><p className="text-sm text-gray-500">Préstamos Activos: <span className={`font-semibold ${isAnyOverdue ? 'text-red-600' : 'text-blue-600'}`}>{totalActiveLoans}</span></p></div>
                            <div className="text-right"><p className="text-xl font-extrabold text-red-600">{CURRENCY_SYMBOL}{totalOutstanding.toFixed(2)}</p><p className="text-xs text-gray-500">Saldo Total Pendiente</p></div>
                        </div>
                    </div>
                );
            };

            const ClientListView = ({ userRole }) => (
                <div className="p-4 md:p-6 space-y-4">
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-2xl font-bold text-gray-800">Listado de Clientes ({clients.length})</h2>
                        {userRole === 'admin' && (
                            <button onClick={() => openModal('Registrar Nuevo Cliente y Préstamo', <ClientForm onSave={handleSaveClient} />)} className="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold hover:bg-green-700 transition shadow-md">+ Añadir Cliente</button>
                        )}
                    </div>
                    {clients.length > 0 ? (<div className="grid gap-4 sm:grid-cols-2 lg:grid-cols-3">{clients.map(client => <ClientListItem key={client.id} client={client} />)}</div>) : (<div className="text-center p-8 bg-white rounded-xl border border-gray-200"><p className="text-gray-600">Aún no hay clientes registrados. ¡Comencemos tu negocio!</p></div>)}
                </div>
            );

            const DashboardView = () => (
                <div className="p-4 md:p-6 space-y-6">
                    <h2 className="text-2xl font-bold text-gray-800 border-b pb-3">Rendimiento Mensual (Intereses)</h2>
                    <div className="grid gap-4 md:grid-cols-2">
                        <StatCard title="Ganancia de Intereses (Este Mes)" value={monthlyPerformance.interestGain} isMoney={true} color="bg-green-700" icon="money" />
                        <StatCard title="Capital Recaudado (Este Mes)" value={monthlyPerformance.principalGain} isMoney={true} color="bg-yellow-700" icon="principal" />
                    </div>
                    <h2 className="text-2xl font-bold text-gray-800 border-b pb-3 pt-6">Resumen de Cartera General</h2>
                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-4">
                        <StatCard title="Préstamos Activos" value={generalSummary.totalLoansActive} isMoney={false} color="bg-blue-700" icon="loans" />
                        <StatCard title="Capital Total Prestado" value={generalSummary.totalPrincipal} isMoney={true} color="bg-blue-900" icon="total" />
                        <StatCard title="Capital Pendiente" value={generalSummary.totalPrincipalRemaining} isMoney={true} color="bg-red-700" icon="remaining" />
                        <StatCard title="Interés Total Histórico Cobrado" value={generalSummary.totalInterestPaid} isMoney={true} color="bg-green-700" icon="paid" />
                    </div>
                    <h3 className="text-xl font-bold text-gray-800 pt-4 border-b pb-2">Resumen por Cliente (Activo)</h3>
                    <div className="space-y-3">
                        {clients.filter(c => c.loans.some(l => calculateLoanBalance(l).totalRemaining > 0.01)).map(client => {
                            const activeLoans = client.loans.filter(l => calculateLoanBalance(l).totalRemaining > 0.01);
                            let totalPending = 0; let isAnyOverdue = false;
                            activeLoans.forEach(loan => { const balance = calculateLoanBalance(loan); totalPending += balance.totalRemaining; if (balance.isOverdue) isAnyOverdue = true; });
                            return (<div key={client.id} className="p-3 bg-white rounded-lg shadow-md flex justify-between items-center cursor-pointer hover:bg-gray-50" onClick={() => { setSelectedClientId(client.id); setCurrentView('clientDetail'); }}><span className="font-semibold text-gray-700">{client.name} {isAnyOverdue && <span className="ml-2 text-xs font-bold text-red-600 animate-pulse">(VENCIDO)</span>}</span><span className="font-bold text-xl text-red-600">{CURRENCY_SYMBOL}{totalPending.toFixed(2)}</span></div>);
                        })}
                    </div>
                </div>
            );
            
            const StatCard = ({ title, value, isMoney, color, icon }) => {
                const getIcon = () => {
                    switch (icon) {
                        case 'money': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>;
                        case 'principal': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>;
                        case 'loans': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8v8m0-8h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>;
                        case 'total': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M12 4.5v15m7.5-7.5h-15"></path></svg>;
                        case 'remaining': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636"></path></svg>;
                        case 'paid': return <svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M9 12l2 2 4-4m5.618-4.237a9.002 9.002 0 01-11.899 0L3.13 7.732A1 1 0 003 8.414V19a2 2 0 002 2h14a2 2 0 002-2V8.414a1 1 0 00-.13-.682l-4.288-4.288z"></path></svg>;
                        default: return null;
                    }
                };
                return (<div className={`p-4 rounded-xl text-white shadow-lg ${color} transition duration-300 hover:scale-[1.02] flex items-center justify-between`}><div><p className="text-sm font-light opacity-90">{title}</p><p className="text-3xl font-extrabold mt-1">{isMoney ? `${CURRENCY_SYMBOL}${value.toFixed(2)}` : value}</p></div><div className="opacity-80">{getIcon()}</div></div>);
            };

            const Modal = ({ title, children, isOpen, onClose }) => {
                if (!isOpen) return null;
                return (
                    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
                        <div className="bg-white rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-y-auto">
                            <div className="p-4 border-b flex justify-between items-center bg-blue-50 rounded-t-xl">
                                <h2 className="text-xl font-bold text-blue-800">{title}</h2>
                                <IconButton onClick={onClose} className="bg-transparent hover:bg-blue-100 text-gray-600 shadow-none"><svg className="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M6 18L18 6M6 6l12 12"></path></svg></IconButton>
                            </div>
                            <div className="p-4">{children}</div>
                        </div>
                    </div>
                );
            };
            
            const ReportsView = ({ clients }) => {
                const [selectedYear, setSelectedYear] = useState(new Date().getFullYear());
                const availableYears = useMemo(() => {
                    const years = new Set([new Date().getFullYear()]);
                    clients.forEach(client => client.loans.forEach(loan => loan.paymentHistory.forEach(payment => {
                        const paymentDate = new Date(payment.date.replace(/-/g, '/'));
                        if (!isNaN(paymentDate.getTime())) years.add(paymentDate.getFullYear());
                    })));
                    return Array.from(years).sort((a, b) => b - a);
                }, [clients]);
                const monthlyData = useMemo(() => calculateHistoricalPerformance(clients, selectedYear), [clients, selectedYear]);
                const totalAnnualInterest = monthlyData.reduce((sum, month) => sum + month, 0);
                const maxMonthValue = Math.max(...monthlyData, 1);
                const months = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

                return (
                    <div className="p-4 md:p-6 space-y-6">
                        <div className="flex justify-between items-center border-b pb-3"><h2 className="text-2xl font-bold text-gray-800">Reporte de Intereses</h2><select value={selectedYear} onChange={(e) => setSelectedYear(parseInt(e.target.value))} className="p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-700">{availableYears.map(year => <option key={year} value={year}>{year}</option>)}</select></div>
                        <div className="bg-white p-6 rounded-xl shadow-lg">
                            <h3 className="text-xl font-semibold text-center text-blue-800 mb-4">Rendimiento Anual de Intereses - {selectedYear}</h3>
                            <p className="text-center text-4xl font-extrabold text-green-700 mb-6">{CURRENCY_SYMBOL}{totalAnnualInterest.toFixed(2)}</p>
                            <div className="grid grid-cols-12 gap-2 h-64 items-end mb-4 px-4">
                                {monthlyData.map((value, index) => (
                                    <div key={index} className="flex flex-col items-center group">
                                        <div className="text-xs font-bold text-gray-700 opacity-0 group-hover:opacity-100 transition-opacity mb-1">{CURRENCY_SYMBOL}{value.toFixed(2)}</div>
                                        <div className="w-full bg-blue-500 hover:bg-blue-700 transition-colors rounded-t-md" style={{ height: `${(value / maxMonthValue) * 100}%` }}></div>
                                        <div className="text-xs font-semibold text-gray-500 mt-1">{months[index].substring(0, 3)}</div>
                                    </div>
                                ))}
                            </div>
                            <div className="mt-8 overflow-x-auto">
                                <table className="min-w-full divide-y divide-gray-200">
                                    <thead className="bg-gray-50"><tr><th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mes</th><th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Intereses Cobrados</th></tr></thead>
                                    <tbody className="bg-white divide-y divide-gray-200">{months.map((month, index) => <tr key={month}><td className="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">{month}</td><td className="px-6 py-4 whitespace-nowrap text-sm text-gray-700 text-right font-semibold">{CURRENCY_SYMBOL}{monthlyData[index].toFixed(2)}</td></tr>)}</tbody>
                                    <tfoot className="bg-blue-50"><tr><td className="px-6 py-3 text-left text-sm font-bold text-blue-800 uppercase">Total Anual</td><td className="px-6 py-3 text-right text-sm font-bold text-blue-800 uppercase">{CURRENCY_SYMBOL}{totalAnnualInterest.toFixed(2)}</td></tr></tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                );
            };

            const renderView = () => {
                switch (currentView) {
                    case 'clientList': return <ClientListView userRole={userRole} />;
                    case 'clientDetail': return selectedClient ? <ClientDetailView client={selectedClient} userRole={userRole} handleDeletePayment={handleDeletePayment} handleDeleteLoan={handleDeleteLoan} handleDeleteClient={handleDeleteClient} /> : <ClientListView userRole={userRole} />;
                    case 'reports': return <ReportsView clients={clients} />;
                    case 'dashboard':
                    default: return <DashboardView />;
                }
            };

            return (
                <div className="bg-gray-100 min-h-screen font-sans">
                    <Header title="PRESTA FÁCIL" onLogout={onLogout} />
                    <Modal title={modalContent.title} isOpen={isModalOpen} onClose={closeModal}>
                        {modalContent.body}
                    </Modal>
                    <div className="flex-grow max-w-7xl w-full mx-auto pb-12">
                        <div className="py-4 px-4 md:px-6 sticky top-16 bg-gray-100 border-b z-5">
                            <div className="flex space-x-2">
                                <button onClick={() => setCurrentView('dashboard')} className={`p-3 rounded-xl font-semibold transition ${currentView === 'dashboard' ? 'bg-blue-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-200'}`}>Dashboard</button>
                                <button onClick={() => setCurrentView('clientList')} className={`p-3 rounded-xl font-semibold transition ${currentView === 'clientList' || currentView === 'clientDetail' ? 'bg-blue-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-200'}`}>Clientes y Préstamos</button>
                                <button onClick={() => setCurrentView('reports')} className={`p-3 rounded-xl font-semibold transition ${currentView === 'reports' ? 'bg-blue-800 text-white shadow-lg' : 'bg-white text-gray-700 hover:bg-gray-200'}`}>Reportes</button>
                            </div>
                        </div>
                        {renderView()}
                    </div>
                </div>
            );
        };
        
        const App = () => {
            const [user, setUser] = useState(null);
            const [userRole, setUserRole] = useState(null);
            const [isLoading, setIsLoading] = useState(true);
            const [authError, setAuthError] = useState('');

            useEffect(() => {
                setupFirebase(async (currentUser) => {
                    if (currentUser) {
                        // User is logged in, fetch their role
                        const db = firebase.firestore();
                        const userRoleRef = db.collection('user_roles').doc(currentUser.uid);
                        try {
                            const doc = await userRoleRef.get();
                            if (doc.exists) {
                                setUserRole(doc.data().role); // e.g., 'admin' or 'viewer'
                            } else {
                                console.warn("Usuario no tiene rol asignado. Asignando solo lectura por defecto.");
                                setUserRole('viewer'); // Secure default
                            }
                        } catch (error) {
                            console.error("Error al obtener el rol del usuario:", error);
                            setUserRole('viewer'); // Secure default on error
                        }
                        setUser(currentUser);
                    } else {
                        // User is logged out, clear all state
                        setUser(null);
                        setUserRole(null);
                    }
                    setIsLoading(false);
                }, setIsLoading);
            }, []);

            const handleLogin = (email, password) => {
                setAuthError(''); // Limpiar errores previos
                firebase.auth().signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        console.error("Error de autenticación:", error.code, error.message);
                        if(error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                            setAuthError('El correo o la contraseña son incorrectos.');
                        } else {
                            setAuthError('Ocurrió un error al intentar iniciar sesión.');
                        }
                    });
            };
            
            const handleLogout = () => {
                firebase.auth().signOut();
            };

            if (isLoading) {
                return (
                    <div className="min-h-screen flex items-center justify-center">
                        <p className="text-lg text-blue-800">Cargando aplicación...</p>
                    </div>
                );
            }

            return user && userRole ? <MainApp user={user} userRole={userRole} onLogout={handleLogout} /> : <LoginView onLogin={handleLogin} error={authError} />;
        };

        // Final render call for the application
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>

